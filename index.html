<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบยืมคืนสินค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-6 max-w-lg">
        <!-- Loading -->
        <div id="loading" class="text-center py-20">
            <div class="spinner mx-auto mb-4"></div>
            <p>กำลังโหลด...</p>
        </div>

        <!-- Main Content -->
        <div id="app" class="hidden">
            <!-- Header -->
            <div class="glass rounded-2xl p-6 mb-4">
                <div class="flex items-center space-x-4">
                    <img id="userPic" src="" class="w-16 h-16 rounded-full border-2 border-white" alt="Profile">
                    <div>
                        <h2 id="userName" class="text-xl font-bold">-</h2>
                        <p id="userRole" class="text-sm opacity-80">-</p>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-2 mb-4">
                <button onclick="showTab('borrow')" id="tab-borrow" class="flex-1 py-2 px-4 rounded-lg bg-white text-purple-600 font-medium">ยืมสินค้า</button>
                <button onclick="showTab('myborrow')" id="tab-myborrow" class="flex-1 py-2 px-4 rounded-lg bg-white/20">รายการของฉัน</button>
                <button onclick="showTab('return')" id="tab-return" class="flex-1 py-2 px-4 rounded-lg bg-white/20">คืนสินค้า</button>
            </div>

            <!-- Content -->
            <div id="content"></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL'; // ⚠️ ใส่ URL ของคุณที่นี่
        let userId = null;
        let currentTab = 'borrow';

        // Init LIFF
        async function initApp() {
            try {
                await liff.init({ liffId: '2008904120-hDgwl23w' });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                userId = profile.userId;

                // Login to system
                const res = await callApi('login', {
                    uid: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl,
                    statusMessage: profile.statusMessage || ''
                });

                if (res.success) {
                    document.getElementById('userPic').src = profile.pictureUrl || 'https://via.placeholder.com/64';
                    document.getElementById('userName').textContent = profile.displayName;
                    
                    const userData = await callApi('getUserProfile', { uid: userId });
                    if (userData.success) {
                        document.getElementById('userRole').textContent = userData.profile.role === 'admin' ? 'ผู้ดูแลระบบ' : 'ผู้ใช้งาน';
                    }

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    showTab('borrow');
                }
            } catch (err) {
                alert('เกิดข้อผิดพลาด: ' + err.message);
            }
        }

        // Call API
        async function callApi(action, data = {}) {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...data })
            });
            return await res.json();
        }

        // Show Tab
        function showTab(tab) {
            currentTab = tab;
            ['borrow', 'myborrow', 'return'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                btn.className = t === tab ? 'flex-1 py-2 px-4 rounded-lg bg-white text-purple-600 font-medium' : 'flex-1 py-2 px-4 rounded-lg bg-white/20';
            });

            if (tab === 'borrow') loadBorrowTab();
            else if (tab === 'myborrow') loadMyBorrowTab();
            else if (tab === 'return') loadReturnTab();
        }

        // Load Borrow Tab
        async function loadBorrowTab() {
            const res = await callApi('getItems');
            const items = res.success ? res.items.filter(i => i.available > 0 && i.status === 'active') : [];
            
            let html = '<div class="space-y-3">';
            if (items.length === 0) {
                html += '<p class="text-center py-8">ไม่มีสินค้าพร้อมยืม</p>';
            } else {
                items.forEach(item => {
                    html += `
                        <div class="glass rounded-xl p-4 hover:bg-white/20 cursor-pointer transition" onclick="borrowItem('${item.id}', '${item.name}', ${item.available})">
                            <h3 class="font-bold">${item.name}</h3>
                            <p class="text-sm opacity-80">${item.description || '-'}</p>
                            <div class="flex justify-between mt-2">
                                <span class="text-xs px-2 py-1 bg-white/20 rounded">${item.category || 'ทั่วไป'}</span>
                                <span class="text-xs text-green-300">✓ ${item.available} ชิ้น</span>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        // Load My Borrow Tab
        async function loadMyBorrowTab() {
            const res = await callApi('getTransactions', { userUid: userId, type: 'borrow' });
            const items = res.success ? res.transactions.filter(t => t.status === 'borrowed') : [];
            
            let html = '<div class="space-y-3">';
            if (items.length === 0) {
                html += '<p class="text-center py-8">คุณยังไม่มีการยืมสินค้า</p>';
            } else {
                items.forEach(item => {
                    html += `
                        <div class="glass rounded-xl p-4">
                            <h3 class="font-bold">${item.item_name}</h3>
                            <p class="text-sm">จำนวน: ${item.quantity} ชิ้น</p>
                            <p class="text-sm">กำหนดคืน: ${formatDate(item.due_date)}</p>
                            <button onclick="returnItem('${item.id}', '${item.item_name}', ${item.quantity})" class="mt-2 w-full py-2 bg-green-500 rounded-lg hover:bg-green-600">คืนสินค้า</button>
                        </div>
                    `;
                });
            }
            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        // Load Return Tab
        async function loadReturnTab() {
            await loadMyBorrowTab();
        }

        // Borrow Item
        async function borrowItem(itemId, itemName, available) {
            const qty = prompt(`ยืม ${itemName}\nจำนวน (มีพร้อม ${available} ชิ้น):`, '1');
            if (!qty || isNaN(qty) || qty < 1 || qty > available) return;

            const dueDate = prompt('กำหนดคืน (yyyy-mm-dd):', new Date(Date.now() + 3*24*60*60*1000).toISOString().split('T')[0]);
            if (!dueDate) return;

            const res = await callApi('borrowItem', {
                uid: userId,
                itemId: itemId,
                quantity: parseInt(qty),
                dueDate: dueDate,
                notes: ''
            });

            alert(res.success ? 'ยืมสินค้าสำเร็จ!' : 'เกิดข้อผิดพลาด: ' + res.message);
            if (res.success) loadBorrowTab();
        }

        // Return Item
        async function returnItem(txId, itemName, qty) {
            if (!confirm(`ยืนยันคืน ${itemName} จำนวน ${qty} ชิ้น?`)) return;

            const res = await callApi('returnItem', {
                uid: userId,
                transactionId: txId,
                notes: ''
            });

            alert(res.success ? 'คืนสินค้าสำเร็จ!' : 'เกิดข้อผิดพลาด: ' + res.message);
            if (res.success) loadMyBorrowTab();
        }

        // Format Date
        function formatDate(d) {
            if (!d) return '-';
            const date = new Date(d);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Start
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
